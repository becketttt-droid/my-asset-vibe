<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="My Assets">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23000000%22 rx=%2220%22 ry=%2220%22/><text x=%2250%22 y=%2250%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2260%22>üìä</text></svg>">

    <title>My Net Worth (V67 Stable)</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --bg: #000000;
            --card: #121212;
            --card-hover: #1a1a1a;
            --nav-bg: #000000;
            
            --text: #ffffff;
            --subtext: #888888;
            --accent: #5c85b3;
            
            --trend-line: #64869b; 
            --trend-high: #64869b; 
            --crosshair: #ffffff; 
            --up: #569C78; 
            --down: #A6444D;
            
            --nav-inactive: #444444;
            --nav-hover: #888888;
            --nav-active: #ffffff;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            
            --ios-ease: cubic-bezier(0.25, 1, 0.5, 1);
            --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @property --pie-p { syntax: '<percentage>'; inherits: false; initial-value: 0%; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; 
            padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-y;
            -webkit-font-smoothing: antialiased;
        }

        .container { 
            width: 100%; max-width: 600px; 
            position: relative; 
            min-height: 100vh;
            padding: calc(20px + var(--safe-top)) 20px calc(90px + var(--safe-bottom)) 20px; 
        }

        /* --- Loading Overlay --- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(15px);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
        }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        
        .spinner {
            width: 44px; height: 44px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; color: var(--subtext); letter-spacing: 1px; font-weight: 500; }

        /* --- Hero Header --- */
        header { 
            text-align: center; 
            margin-bottom: 25px; 
            margin-top: 10px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .total-title { 
            font-size: 13px; color: #666; letter-spacing: 2px; 
            text-transform: uppercase; margin-bottom: 8px; font-weight: 600;
        }
        .total-amount-box {
            display: flex; align-items: baseline; justify-content: center;
            line-height: 1; gap: 6px;
            white-space: nowrap; flex-wrap: nowrap;
        }
        .currency-symbol { font-size: 20px; font-weight: 500; color: var(--subtext); transform: translateY(-6px); }
        .total-main-num {
            font-size: clamp(36px, 11vw, 60px); font-weight: 700; color: #fff;
            font-variant-numeric: tabular-nums; letter-spacing: -1px;
        }
        .unit-tag { font-size: 20px; font-weight: 500; color: var(--text); }

        /* --- Page & Transitions --- */
        .page { display: none; width: 100%; opacity: 0; transform: translateY(10px) scale(0.99); }
        .page.active { display: block; animation: pageEnter 0.6s var(--ios-ease) forwards; }
        @keyframes pageEnter { from { opacity: 0; transform: translateY(10px) scale(0.99); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .slide-in-right { animation: slideInRight 0.5s var(--ios-ease) forwards; }
        .slide-in-left { animation: slideInLeft 0.5s var(--ios-ease) forwards; }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }

        /* --- Navigation Bar --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(20px);
            border-top: 1px solid #1a1a1a;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: var(--safe-bottom);
            height: calc(60px + var(--safe-bottom));
            z-index: 100;
            transition: all 0.3s ease;
        }
        .nav-item { flex: 1; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: transform 0.2s var(--ios-ease); }
        .nav-item:active { transform: scale(0.92); }
        .nav-item:hover .nav-icon svg { fill: var(--nav-hover); opacity: 1; transform: translateY(-3px); filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
        .nav-item.active .nav-icon svg { fill: var(--nav-active); opacity: 1; transform: translateY(-5px) scale(1.15); filter: drop-shadow(0 0 8px rgba(255,255,255,0.6)); }
        .nav-item.active::after { content: ''; position: absolute; bottom: 12px; width: 4px; height: 4px; border-radius: 50%; background-color: var(--nav-active); box-shadow: 0 0 6px var(--nav-active); animation: dotPop 0.5s var(--ease-elastic); }
        @keyframes dotPop { from { transform: scale(0); } to { transform: scale(1); } }
        .nav-icon svg { width: 24px; height: 24px; fill: var(--nav-inactive); transition: all 0.5s var(--ease-elastic); opacity: 0.6; }

        /* --- Config Box --- */
        .config-box { background: #121212; padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 1px solid #222; }
        .csv-input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; font-size: 14px; margin-top: 10px; outline: none; color: #888; transition: border-color 0.3s; }
        .csv-input:focus { border-color: var(--accent); color: #fff; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .toolbar-left { display: flex; gap: 10px; }
        .btn-base { cursor: pointer; font-weight: 600; font-size: 12px; padding: 6px 12px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; transition: all 0.2s ease; }
        .btn-base:hover { transform: translateY(-1px); filter: brightness(1.2); }
        .btn-base:active { transform: translateY(1px); filter: brightness(0.9); }
        .btn-refresh { color: var(--accent); background: rgba(92, 133, 179, 0.15); }
        .btn-edit { color: #569C78; background: rgba(86, 156, 120, 0.15); }
        .rate-pill { font-size: 13px; color: #aaa; background: #222; padding: 6px 12px; border-radius: 8px; display: flex; align-items: center; gap: 6px; }
        .rate-val { color: #fff; font-weight: bold; font-family: monospace; font-size: 14px; }

        /* --- Trend Chart --- */
        .trend-wrapper { width: 100%; height: 200px; margin-bottom: 30px; position: relative; background: #121212; border-radius: 16px; overflow: hidden; display: none; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); user-select: none; transition: transform 0.3s var(--ios-ease); }
        .trend-svg { width: 100%; height: 100%; display: block; }
        .trend-line { fill: none; stroke: var(--trend-line); stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; vector-effect: non-scaling-stroke; }
        /* V67: Area fade in delay 2s to match line drawing */
        .trend-area { fill: url(#trendGradient); stroke: none; opacity: 0; transition: opacity 1s ease 2s; }
        .trend-area.visible { opacity: 0.6; }
        .chart-labels-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .chart-label { position: absolute; color: var(--trend-high); font-size: 12px; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.8); white-space: nowrap; transform: translateX(-50%); opacity: 0; transition: opacity 0.5s ease 2s; }
        .chart-label.visible { opacity: 1; }
        .chart-label.left { transform: translateX(5px); }
        .chart-label.right { transform: translateX(calc(-100% - 5px)); }
        .crosshair-line { stroke: var(--crosshair); stroke-width: 1; opacity: 0.5; vector-effect: non-scaling-stroke; }
        .crosshair-dot-html { position: absolute; width: 8px; height: 8px; background-color: var(--crosshair); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; opacity: 0; transition: opacity 0.1s; z-index: 15; box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.5); }
        .chart-hud { position: absolute; top: 12px; left: 15px; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 20; display: flex; flex-direction: column; gap: 2px; }
        .chart-hud.visible { opacity: 1; }
        .hud-date { color: var(--subtext); font-size: 11px; font-weight: 600; }
        .hud-val { color: #fff; font-size: 15px; font-weight: bold; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .hud-delta { font-size: 11px; font-weight: 600; margin-top: 2px; display: flex; align-items: center; gap: 4px; }
        .hud-delta.up { color: var(--up); }
        .hud-delta.down { color: var(--down); }
        .hud-delta.flat { color: var(--subtext); }
        .trend-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; z-index: 10; }

        /* Structure Bar */
        .structure-container { width: 100%; margin-bottom: 20px; padding: 0 10px; }
        .structure-bar { width: 100%; height: 24px; background: #222; border-radius: 12px; display: flex; overflow: hidden; margin-bottom: 10px; }
        .struct-seg { height: 100%; width: 0%; transition: width 1.2s var(--ios-ease); }
        .struct-metrics { display: flex; justify-content: space-between; width: 100%; font-size: 12px; color: var(--subtext); }
        .struct-metric-item { text-align: center; }
        .metric-big.net-highlight { color: #3E7091; }
        .metric-big { font-size: 18px; font-weight: bold; color: #fff; display: block; }
        .metric-label { font-size: 10px; opacity: 0.7; }

        /* Analysis Grid */
        .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 600px) { .analysis-grid { grid-template-columns: 1fr 1fr; } }
        .chart-card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid #1a1a1a; display: flex; flex-direction: column; align-items: center; transition: transform 0.3s var(--ios-ease), border-color 0.3s; }
        .chart-card:hover { transform: translateY(-3px); border-color: #333; }
        .chart-title { font-size: 14px; font-weight: bold; margin-bottom: 15px; color: var(--subtext); width: 100%; text-align: center; }
        .chart-container { width: 160px; height: 160px; border-radius: 50%; margin-bottom: 15px; background: #222; position: relative; }
        .pie-ring { width: 100%; height: 100%; border-radius: 50%; --pie-p: 0%; mask: conic-gradient(#000 var(--pie-p), transparent var(--pie-p)); -webkit-mask: conic-gradient(#000 var(--pie-p), transparent var(--pie-p)); }
        .pie-anim .pie-ring { animation: pieReveal 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes pieReveal { from { --pie-p: 0%; } to { --pie-p: 100%; } }
        .chart-inner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 110px; height: 110px; background-color: var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column; color: var(--subtext); font-size: 12px; text-align: center; z-index: 2; }
        .chart-inner .inner-val { font-size: 16px; font-weight: bold; color: #fff; }
        .chart-inner .inner-label { font-size: 10px; color: #888; margin-top: 2px; }
        .legend-box { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; width: 100%; }
        .legend-item { display: flex; align-items: center; background: #222; padding: 4px 10px; border-radius: 20px; font-size: 11px; border: 1px solid #333; white-space: nowrap; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        /* V65: Analysis Extended Grid */
        .analysis-extended { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; width: 100%; }
        
        .kpi-row { display: flex; justify-content: space-between; width: 100%; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; }
        .kpi-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .kpi-label { font-size: 12px; color: var(--subtext); }
        .kpi-value { font-size: 16px; font-weight: bold; color: #fff; font-family: ui-monospace, monospace; }
        .kpi-sub { font-size: 10px; opacity: 0.8; margin-top: 2px; }
        .val-good { color: #569C78; } .val-bad { color: #A6444D; } .val-neu { color: #888; }
        
        .risk-bar-container { width: 100%; display: flex; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 10px; margin-bottom: 5px;}
        .risk-seg { height: 100%; transition: width 1s var(--ios-ease); }
        .risk-legend { display: flex; justify-content: space-between; width: 100%; font-size: 10px; color: var(--subtext); margin-bottom: 15px;}

        .holding-item { width: 100%; margin-bottom: 12px; }
        .holding-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; color: #fff; }
        .holding-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .holding-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; width: 0%; transition: width 1.5s var(--ios-ease); }
        
        /* Asset List */
        .asset-list-container { display: grid; gap: 12px; align-items: start; }
        
        .category-group { border-radius: 16px; overflow: hidden; background-color: var(--card); border: 1px solid #1a1a1a; transition: all 0.3s var(--ios-ease); opacity: 0; transform: translateY(20px); position: relative; }
        .category-group:hover { transform: translateY(-2px); background-color: var(--card-hover); border-color: #333; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .category-group.open { box-shadow: 0 10px 30px rgba(255,255,255,0.05); border-color: #333; }
        .category-header { padding: 16px; min-height: 64px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 10px; position: relative; z-index: 2; }
        
        .weight-bar { position: absolute; top: 0; left: 0; bottom: 0; width: 0%; transition: width 1.2s var(--ios-ease); z-index: 0; opacity: 0.15; pointer-events: none; }

        .cat-left-content { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; position: relative; z-index: 1; }
        .cat-icon-box { width: 32px; height: 32px; border-radius: 8px; display: flex; justify-content: center; align-items: center; transition: transform 0.3s var(--ease-elastic); flex-shrink: 0; }
        .category-group:hover .cat-icon-box { transform: scale(1.1); }
        .cat-icon-box svg { width: 18px; height: 18px; }
        .cat-text-info { display: flex; align-items: baseline; gap: 6px; overflow: hidden; }
        .cat-name { font-size: 15px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cat-count { font-size: 10px; color: var(--subtext); background: #222; padding: 1px 6px; border-radius: 8px; white-space: nowrap; display: none; }
        @media (min-width: 360px) { .cat-count { display: inline-block; } }
        .cat-right-content { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; flex-shrink: 0; position: relative; z-index: 1; }
        .cat-amount { font-size: 15px; font-weight: 700; color: #fff; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-variant-numeric: tabular-nums; letter-spacing: -0.3px; line-height: 1.2; }
        .cat-pct { font-size: 11px; color: var(--subtext); margin-top: 2px; }
        .arrow-icon { transition: transform 0.3s ease; opacity: 0.4; font-size: 10px; margin-left: 5px; flex-shrink: 0; position: relative; z-index: 1; }
        .category-group.open .arrow-icon { transform: rotate(180deg); opacity: 1; }
        .category-content { max-height: 0; overflow: hidden; transition: max-height 0.4s var(--ios-ease); background-color: #000; }
        .category-group.open .category-content { max-height: 2000px; }
        .asset-item { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; transition: background 0.2s; }
        .asset-item:hover { background: #0a0a0a; }
        .asset-item:last-child { border-bottom: none; }
        .asset-info h4 { margin: 0 0 2px 0; font-size: 14px; color: #eee; }
        .asset-info p { margin: 0; font-size: 11px; color: var(--subtext); }
        .asset-val { text-align: right; font-weight: 500; font-size: 14px; font-family: ui-monospace, monospace; }
        .asset-val small { font-size: 10px; opacity: 0.7; display: block;}
        .is-debt .cat-amount, .is-debt .asset-val { color: #A6444D; }
        .is-interest .asset-val { color: #596275; }
        
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #fff; padding-left: 5px; border-left: 3px solid var(--accent); line-height: 1; margin-top: 10px;}
        
        @media (min-width: 1024px) {
            .container { max-width: 1200px; padding-bottom: 40px; }
            #page-home { display: grid !important; grid-template-columns: 2fr 1fr; gap: 20px; align-items: start; }
            header { grid-column: 1 / -1; margin-bottom: 30px; }
            .trend-wrapper { height: 400px; margin-bottom: 0; }
            .chart-card { height: 100%; justify-content: center; }
            .analysis-extended { grid-template-columns: 1fr 1fr; }
            .analysis-grid { grid-template-columns: repeat(4, 1fr); gap: 20px; }
            .asset-list-container { grid-template-columns: repeat(3, 1fr); gap: 20px; }
            .nav-bar { width: 400px; left: 50%; transform: translateX(-50%); bottom: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay active">
    <div class="spinner"></div>
    <div class="loading-text">ÂêåÊ≠•Ë≥áÁî¢Êï∏Êìö...</div>
</div>

<div class="container" id="mainContainer">
    <div id="page-home" class="page active">
        <header>
            <div class="total-title">NET WORTH</div>
            <div class="total-amount-box" id="displayTotalBox">
                <span class="currency-symbol">NT$</span>
                <span class="total-main-num" id="displayTotal">0</span>
                <span class="unit-tag" id="displayUnit"></span>
            </div>
        </header>

        <div id="trendChartWrapper" class="trend-wrapper">
            <div id="chartHud" class="chart-hud">
                <div id="hudDate" class="hud-date">DATE</div>
                <div id="hudVal" class="hud-val">VALUE</div>
                <div id="hudDelta" class="hud-delta">0% to Today</div>
            </div>
            <svg id="trendSvg" class="trend-svg" viewBox="0 0 1000 200" preserveAspectRatio="none">
                <defs>
                    <linearGradient id="trendGradient" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stop-color="#64869b" stop-opacity="0.3"/>
                        <stop offset="100%" stop-color="#64869b" stop-opacity="0"/>
                    </linearGradient>
                </defs>
                <g id="crosshairGroup" style="opacity: 0;">
                    <line id="crosshairX" y1="0" y2="200" class="crosshair-line" />
                    <line id="crosshairY" x1="0" x2="1000" class="crosshair-line" />
                </g>
            </svg>
            <div id="chartLabels" class="chart-labels-container"></div>
            <div id="crosshairDotHtml" class="crosshair-dot-html"></div>
            <div id="trendOverlay" class="trend-overlay"></div>
        </div>

        <div class="chart-card">
            <div class="chart-title">Ë≥áÈáëÁµêÊßã (Structure)</div>
            <div class="structure-container">
                <div class="struct-metrics" style="margin-bottom:10px;">
                    <div class="struct-metric-item" style="text-align:left;">
                        <span class="metric-big net-highlight" id="structNetWorth">0</span>
                        <span class="metric-label">Ê∑®ÂÄº (Net Worth)</span>
                    </div>
                    <div class="struct-metric-item" style="text-align:right;">
                        <span class="metric-big" style="color:#A6444D;" id="structDebtRatio">0%</span>
                        <span class="metric-label">Ë≤†ÂÇµÊØî (Debt Ratio)</span>
                    </div>
                </div>
                <div class="structure-bar">
                    <div id="barNetworth" class="struct-seg" style="background:#3E7091;"></div>
                    <div id="barDebt" class="struct-seg" style="background:#A6444D;"></div>
                    <div id="barInterest" class="struct-seg" style="background:#596275;"></div>
                </div>
            </div>
            <div id="legendLeverage" class="legend-box"></div>
        </div>
    </div>

    <div id="page-analysis" class="page">
        <div class="section-title">Ê∑±Â∫¶Ê¥ûÂØü</div>
        <div class="analysis-extended">
            <div class="chart-card" style="align-items:flex-start;">
                <div class="chart-title" style="text-align:left;">Ë≤°ÂãôÂÅ•Ê™¢ (Health)</div>
                <div style="width:100%;">
                    <div class="kpi-row"><div><div class="kpi-label">Ê∑®ÊµÅÂãïË≥áÁî¢ (Net Liquid)</div><div class="kpi-sub">ËÆäÁèæËÉΩÂäõ</div></div><div class="kpi-value" id="kpiNetLiquid">0</div></div>
                    <div class="kpi-row"><div><div class="kpi-label">ÊµÅÂãïÂÑüÂÇµÁéá (Solvency)</div><div class="kpi-sub">ÊµÅÂãïË≥áÁî¢ √∑ Á∏ΩË≤†ÂÇµ</div></div><div class="kpi-value" id="kpiSolvency">0x</div></div>
                    <div class="kpi-row"><div><div class="kpi-label">Á∏ΩË≤†ÂÇµ (Total Debt)</div><div class="kpi-sub">ÊßìÊ°øÁ∏ΩÈ°ç</div></div><div class="kpi-value val-bad" id="kpiTotalDebt">0</div></div>
                </div>
            </div>
            <div class="chart-card" style="align-items:flex-start;">
                <div class="chart-title" style="text-align:left;">ÊàêÈï∑ÂãïËÉΩ (Growth)</div>
                <div style="width:100%;">
                    <div class="kpi-row"><div><div class="kpi-label">ÊúàÁí∞ÊØî (MoM)</div><div class="kpi-sub">vs ‰∏äÂÄãÊúà</div></div><div class="kpi-value" id="kpiMoM">0%</div></div>
                    <div class="kpi-row"><div><div class="kpi-label">‰ªäÂπ¥‰ª•‰æÜ (YTD)</div><div class="kpi-sub">vs 1Êúà1Êó•</div></div><div class="kpi-value" id="kpiYTD">0%</div></div>
                    <div class="kpi-row"><div><div class="kpi-label">Ë∑ùÈõ¢È´òÈªû (vs ATH)</div><div class="kpi-sub">Ë≥áÁî¢ÊúÄÈ´òÁ¥ÄÈåÑ</div></div><div class="kpi-value" id="kpiATH">0%</div></div>
                </div>
            </div>
            <div class="chart-card" style="align-items:flex-start;">
                <div class="chart-title" style="text-align:left;">È¢®Èö™Â±¨ÊÄß (Risk Profile)</div>
                <div style="width:100%; margin-top:10px;">
                    <div class="risk-bar-container">
                        <div id="riskAggressive" class="risk-seg" style="background:#B85C5C; width:0%"></div>
                        <div id="riskDefensive" class="risk-seg" style="background:#569C78; width:0%"></div>
                        <div id="riskAnchor" class="risk-seg" style="background:#786FA6; width:0%"></div>
                    </div>
                    <div class="risk-legend">
                        <span>üî¥ ÈÄ≤Êîª <span id="valAggressive">0%</span></span>
                        <span>üü¢ Èò≤ÂÆà <span id="valDefensive">0%</span></span>
                        <span>üü£ Â£ìËâô <span id="valAnchor">0%</span></span>
                    </div>
                </div>
            </div>
            <div class="chart-card" style="align-items:flex-start;">
                <div class="chart-title" style="text-align:left;">Ââç‰∫îÂ§ßÊåÅÂÄâ (Top 5)</div>
                <div id="topHoldingsList" style="width:100%;"></div>
            </div>
        </div>

        <div class="section-title">Ë≥áÁî¢ÂàÜ‰Ωà</div>
        <div class="analysis-grid">
            <div class="chart-card"><div class="chart-title">Ë≥áÁî¢ÈÖçÁΩÆ (Assets)</div><div class="chart-container"><div id="chartCategory" class="pie-ring"></div><div class="chart-inner"><div class="inner-val" id="valCategory">0</div><div class="inner-label">Á∏ΩË≥áÁî¢</div></div></div><div id="legendCategory" class="legend-box"></div></div>
            <div class="chart-card"><div class="chart-title">Ë≤†ÂÇµÂàÜ‰Ωà (Liabilities)</div><div class="chart-container"><div id="chartDebt" class="pie-ring"></div><div class="chart-inner"><div class="inner-val" id="valDebt">0</div><div class="inner-label">Á∏ΩË≤†ÂÇµ</div></div></div><div id="legendDebt" class="legend-box"></div></div>
            <div class="chart-card"><div class="chart-title">ÊµÅÂãïÊÄß (Liquidity)</div><div class="chart-container"><div id="chartLiquidity" class="pie-ring"></div><div class="chart-inner"><div class="inner-val" id="valLiquidity">0</div><div class="inner-label">Á∏ΩÊµÅÂãï</div></div></div><div id="legendLiquidity" class="legend-box"></div></div>
            <div class="chart-card"><div class="chart-title">Âπ£Âà•ÊõùÈö™ (Currency)</div><div class="chart-container"><div id="chartCurrency" class="pie-ring"></div><div class="chart-inner"><div class="inner-val" id="valCurrency">0</div><div class="inner-label">Á∏ΩÊõùÈö™</div></div></div><div id="legendCurrency" class="legend-box"></div></div>
        </div>
    </div>

    <div id="page-list" class="page">
        <div class="section-title">Ë≥áÁî¢Ê∏ÖÂñÆ</div>
        <div id="assetListContainer" class="asset-list-container"></div>
    </div>

    <div id="page-settings" class="page">
        <div class="section-title">Ë®≠ÂÆö</div>
        <div class="config-wrapper">
            <div class="config-box">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <a href="https://docs.google.com/spreadsheets/d/1HrG-LV9lYJ0c4OCBFmqz_gGGyIdWHHK92eNSyCPOCuU/edit?usp=drivesdk" target="_blank" class="btn-base btn-edit">üìù Á∑®ËºØÊï∏Êìö</a>
                        <span class="btn-base btn-refresh" onclick="fetchData()">üîÑ Á´ãÂç≥ÈáçÊï¥</span>
                    </div>
                    <div class="rate-pill">
                        <span>üá∫üá∏</span>
                        <span id="rateDisplay" class="rate-val">32.5</span>
                    </div>
                </div>
                <input type="text" id="csvUrl" class="csv-input" placeholder="Google Sheet CSV ÈÄ£Áµê..." onchange="saveUrl()">
                <div id="errorMsg" class="error-text"></div>
            </div>
            <div style="text-align:center; margin-top:20px; color:#555; font-size:12px;">
                Vibe Coding V67.0<br>Stable & Integer
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchPage('home', this)"><div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></div></div>
        <div class="nav-item" onclick="switchPage('analysis', this)"><div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M11 2v20c-5.07-.5-9-4.79-9-10s4.07-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/></svg></div></div>
        <div class="nav-item" onclick="switchPage('list', this)"><div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></div></div>
        <div class="nav-item" onclick="switchPage('settings', this)"><div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div></div>
    </nav>
</div>

<script>
    const colors = { 
        us_stock: '#4A6F8A', tw_stock: '#B85C5C', bond: '#B59C56', cash: '#569C78', realestate: '#786FA6', 
        car: '#B07C56', debt: '#A6444D', interest: '#596275',
        liquid: '#569C78', fixed: '#786FA6', usd: '#4A6F8A', twd: '#B85C5C', networth: '#3E7091'
    };
    
    const typeLabels = { 
        us_stock: 'ÁæéËÇ°', tw_stock: 'Âè∞ËÇ°', bond: 'ÂÇµÂà∏', cash: 'ÁèæÈáë/Â≠òÊ¨æ', 
        realestate: 'ÊàøÁî¢', car: 'ËªäËºõ', debt: 'Ë≤†ÂÇµÊú¨Èáë', interest: 'Âà©ÊÅØ',
        liquid: 'ÊµÅÂãï', fixed: 'Âõ∫ÂÆö', usd: 'ÁæéÂÖÉ', twd: 'Âè∞Âπ£', networth: 'Ê∑®ÂÄº'
    };

    const categoryIcons = {
        realestate: '<path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/>',
        car: '<path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>',
        cash: '<path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h1c1.1 0 2 .9 2 2v6c0 1.1-.9 2-2 2h-1zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>',
        us_stock: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>',
        tw_stock: '<path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/>',
        bond: '<path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>',
        debt: '<path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>',
        interest: '<path d="M13.5 17c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zm-3-6c.83 0 1.5-.67 1.5-1.5S11.33 8 10.5 8 9 8.67 9 9.5 9.67 11 10.5 11zM19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>',
        default: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>'
    };
    
    document.getElementById('csvUrl').value = localStorage.getItem('vibeSheetUrl') || '';
    let currentRate = parseFloat(localStorage.getItem('vibeUsdRate')) || 32.5;
    document.getElementById('rateDisplay').innerText = currentRate;
    if(document.getElementById('csvUrl').value) fetchData();

    const pages = ['home', 'analysis', 'list', 'settings'];
    const container = document.getElementById('mainContainer');
    let startX = 0;
    
    document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive: true});

    document.addEventListener('touchend', e => {
        const endX = e.changedTouches[0].clientX;
        const diff = startX - endX;
        
        if (Math.abs(diff) > 50) {
            const activePage = document.querySelector('.page.active');
            const currentIndex = pages.indexOf(activePage.id.replace('page-', ''));
            
            if (diff > 0) {
                if (currentIndex < pages.length - 1) { switchPage(pages[currentIndex + 1], null, 'left'); }
            } else {
                if (currentIndex > 0) { switchPage(pages[currentIndex - 1], null, 'right'); }
            }
        }
    }, {passive: true});

    function switchPage(pageId, navEl, direction = 'none') {
        const targetPage = document.getElementById('page-' + pageId);
        const allPages = document.querySelectorAll('.page');
        
        allPages.forEach(p => { p.classList.remove('active', 'slide-in-right', 'slide-in-left'); });
        
        if (direction === 'left') targetPage.classList.add('slide-in-right');
        else if (direction === 'right') targetPage.classList.add('slide-in-left');
        else targetPage.style.animation = 'pageEnter 0.6s var(--ios-ease) forwards';
        
        targetPage.classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const navIndex = pages.indexOf(pageId);
        const navItems = document.querySelectorAll('.nav-item');
        if(navItems[navIndex]) navItems[navIndex].classList.add('active');
        
        if(pageId === 'home') {
            if(window.cachedTotal) {
                let displayNum = window.cachedTotal;
                let suffix = "";
                if(Math.abs(window.cachedTotal) >= 100000000) { suffix = " ÂÑÑ"; displayNum = window.cachedTotal / 100000000; }
                else if (Math.abs(window.cachedTotal) >= 10000) { suffix = " Ëê¨"; displayNum = window.cachedTotal / 10000; }
                animateValue(document.getElementById('displayTotal'), 0, displayNum, 2000, window.cachedTotal < 0, "", "");
                document.getElementById('displayUnit').innerText = suffix;
            }
            const bars = document.querySelectorAll('.struct-seg');
            bars.forEach(b => { const w = b.style.width; b.style.width = '0%'; setTimeout(() => b.style.width = w, 50); });
            requestAnimationFrame(() => {
                const line = document.querySelector('.trend-line');
                const area = document.querySelector('.trend-area');
                if(line) {
                    line.style.transition = 'none'; line.style.strokeDasharray = line.getTotalLength(); line.style.strokeDashoffset = line.getTotalLength();
                    if(area) area.classList.remove('visible');
                    requestAnimationFrame(() => {
                        line.getBoundingClientRect(); line.style.transition = 'stroke-dashoffset 2s var(--ios-ease)'; line.style.strokeDashoffset = '0';
                        if(area) setTimeout(() => area.classList.add('visible'), 1500); 
                    });
                    document.querySelectorAll('.chart-label').forEach(l => { l.classList.remove('visible'); setTimeout(() => l.classList.add('visible'), 100); });
                }
            });
        }
        if(pageId === 'analysis') {
            document.querySelectorAll('.chart-card').forEach(card => { card.classList.remove('pie-anim'); void card.offsetWidth; card.classList.add('pie-anim'); });
            document.querySelectorAll('.holding-bar-fill').forEach(bar => { const w = bar.style.width; bar.style.width = '0%'; setTimeout(() => bar.style.width = w, 100); });
            document.querySelectorAll('.risk-seg').forEach(bar => { const w = bar.style.width; bar.style.width = '0%'; setTimeout(() => bar.style.width = w, 100); });
        }
        if(pageId === 'list') {
            const cards = document.querySelectorAll('.category-group');
            cards.forEach((card, index) => { card.style.opacity = '0'; card.style.transform = 'translateY(20px)'; setTimeout(() => { card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, index * 80); });
            document.querySelectorAll('.weight-bar').forEach(bar => { const w = bar.style.width; bar.style.width = '0%'; setTimeout(() => bar.style.width = w, 200); });
            document.querySelectorAll('.cat-amount').forEach(el => {
                const targetText = el.getAttribute('data-value');
                if(targetText) {
                    const cleanVal = targetText.replace(/[^0-9.-]+/g,""); const num = parseFloat(cleanVal);
                    let suffix = ""; let displayNum = num;
                    if(Math.abs(num) >= 100000000) { suffix = " ÂÑÑ"; displayNum = num / 100000000; } 
                    else if (Math.abs(num) >= 10000) { suffix = " Ëê¨"; displayNum = num / 10000; }
                    animateValue(el, 0, displayNum, 2500, targetText.includes('-'), suffix, "NT$ ");
                }
            });
        }
    }

    function animateValue(obj, start, end, duration, isNegative, suffix, prefix = "") {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const easeProgress = 1 - Math.pow(1 - progress, 5);
            const currentVal = easeProgress * (end - start) + start;
            // V67 FIX: Force Round
            let displayStr = Math.round(currentVal).toLocaleString();
            let sign = isNegative ? "- " : "";
            obj.innerHTML = prefix + sign + displayStr + suffix;
            if (progress < 1) { window.requestAnimationFrame(step); } 
            else {
                // V67 FIX: Final value round
                let finalStr = Math.round(end).toLocaleString();
                obj.innerHTML = prefix + sign + finalStr + suffix;
            }
        };
        window.requestAnimationFrame(step);
    }

    function saveUrl() { localStorage.setItem('vibeSheetUrl', document.getElementById('csvUrl').value); fetchData(); }
    
    function csvSplit(str) {
        const result = []; let current = ''; let inQuote = false;
        for (let i = 0; i < str.length; i++) {
            const char = str[i];
            if (char === '"') { inQuote = !inQuote; continue; }
            if (char === ',' && !inQuote) { result.push(current.trim()); current = ''; } else { current += char; }
        }
        result.push(current.trim()); return result;
    }
    
    function formatCompact(num) {
        if (num >= 100000000) return (num / 100000000).toFixed(0) + 'ÂÑÑ';
        if (num >= 10000) return (num / 10000).toFixed(0) + 'Ëê¨';
        return (num / 1000).toFixed(1) + 'k';
    }
    
    function formatChineseCurrency(num) {
        if (Math.abs(num) >= 100000000) return Math.round(num / 100000000).toLocaleString() + ' ÂÑÑ';
        if (Math.abs(num) >= 10000) return Math.round(num / 10000).toLocaleString() + ' Ëê¨';
        return Math.round(num).toLocaleString();
    }
    
    function formatTrendVal(num) { return (num > 0 ? "+" : "") + Math.round(num).toLocaleString(); }
    function toggleGroup(header) { header.parentElement.classList.toggle('open'); }

    async function fetchData(needsNetwork = true) {
        document.getElementById('loadingOverlay').classList.add('active');
        document.getElementById('errorMsg').style.display = 'none';
        
        try {
            let url = document.getElementById('csvUrl').value.trim();
            if (!url) return; 
            
            if (!needsNetwork && window.cachedCSV) { parseCSV(window.cachedCSV); return; }

            const cacheBuster = encodeURIComponent(url + '&t=' + Date.now());
            const proxies = [
                'https://api.allorigins.win/raw?url=' + cacheBuster,
                'https://corsproxy.io/?' + cacheBuster,
                'https://thingproxy.freeboard.io/fetch/' + cacheBuster
            ];
            
            let text = ''; let success = false;
            for (let proxy of proxies) {
                try {
                    const res = await fetch(proxy);
                    if (res.ok) {
                        text = await res.text();
                        if (!text.trim().startsWith('<!DOCTYPE html') && !text.includes('<html')) { success = true; break; }
                    }
                } catch (e) { }
            }
            
            if (success) { window.cachedCSV = text; parseCSV(text); } 
            else { throw new Error("ÁÑ°Ê≥ïÈÄ£Á∑öËá≥ Google Sheet"); }
            
        } catch (e) {
            console.error(e);
            document.getElementById('errorMsg').style.display = 'block';
            document.getElementById('errorMsg').innerHTML = `‚ö†Ô∏è ËÆÄÂèñÂ§±ÊïóÔºö${e.message || "Ë´ãÊ™¢Êü•ÈÄ£Áµê"}`;
        } finally {
            setTimeout(() => document.getElementById('loadingOverlay').classList.remove('active'), 600);
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.split('\n');
        let foundRate = false;
        if (lines.length > 1) {
            const row2 = csvSplit(lines[1]); 
            if (row2.length >= 6) {
                const r = parseFloat(row2[5].replace(/,/g, ''));
                if (!isNaN(r) && r > 20 && r < 50) { 
                    currentRate = r; document.getElementById('rateDisplay').innerText = currentRate;
                    localStorage.setItem('vibeUsdRate', currentRate);
                }
            }
        }

        let totalNetWorth = 0; let totalAssetsOnly = 0;
        let totalDebtAbs = 0; let totalInterestAbs = 0;
        
        let cats = { us_stock:0, tw_stock:0, bond:0, cash:0, realestate:0, car:0, debt:0, interest:0 };
        let liquidity = { liquid: 0, fixed: 0 };
        let currency = { usd: 0, twd: 0 };
        let leverage = { networth: 0, debt: 0, interest: 0 };
        let debtBreakdown = { debt: 0, interest: 0 };
        let historyData = [];
        let groups = { realestate: [], car: [], cash: [], us_stock: [], tw_stock: [], bond: [], debt: [] };
        let allAssets = [];

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const row = csvSplit(lines[i]); 
            if (row.length < 4) continue;
            let rawPrice = row[2] ? row[2].replace(/,/g, '') : '0';
            let rawQty = row[3] ? row[3].replace(/,/g, '') : '0';
            const price = parseFloat(rawPrice); const qty = parseFloat(rawQty);   
            if (isNaN(qty) || isNaN(price)) continue;

            const typeStr = row[0].toLowerCase().trim(); const name = row[1]; 
            let category = 'cash'; let displayCategory = 'cash';
            
            if (typeStr === 'history') { historyData.push({ date: name, val: price * qty }); continue; }

            if (typeStr === 'debt') { category = 'debt'; displayCategory = 'debt'; }
            else if (typeStr === 'interest') { category = 'interest'; displayCategory = 'debt'; }
            else if (typeStr.includes('realestate') || typeStr.includes('house')) { category = 'realestate'; displayCategory = 'realestate'; }
            else if (typeStr.includes('car')) { category = 'car'; displayCategory = 'car'; }
            else if (typeStr.includes('bond')) { category = 'bond'; displayCategory = 'bond'; }
            else if (typeStr.includes('cash') || typeStr.includes('deposit') || typeStr.includes('bank') || typeStr.includes('saving') || typeStr.includes('money') || typeStr === 'twd') { category = 'cash'; displayCategory = 'cash'; } 
            else if (typeStr.includes('us')) { category = 'us_stock'; displayCategory = 'us_stock'; }
            else if (typeStr.includes('stock') || typeStr.includes('tw') || typeStr.includes('0050')) { category = 'tw_stock'; displayCategory = 'tw_stock'; }

            let valTWD = 0; let displayPrice = '';
            const isAssetUSD = (category === 'us_stock') || (typeStr.includes('us') && !typeStr.includes('twd'));

            if (isAssetUSD) { valTWD = qty * price * currentRate; displayPrice = `US$ ${price.toLocaleString()}`; } 
            else { valTWD = qty * price; displayPrice = `NT$ ${price.toLocaleString()}`; }

            if(!cats[category]) cats[category] = 0; cats[category] += valTWD;
            
            if (category === 'debt') { totalNetWorth -= valTWD; totalDebtAbs += valTWD; debtBreakdown.debt += valTWD; } 
            else if (category === 'interest') { totalNetWorth -= valTWD; totalInterestAbs += valTWD; debtBreakdown.interest += valTWD; } 
            else {
                totalNetWorth += valTWD; totalAssetsOnly += valTWD;
                if (['realestate','car'].includes(category)) liquidity.fixed += valTWD; else liquidity.liquid += valTWD;
                if (isAssetUSD) currency.usd += valTWD; else currency.twd += valTWD;
                allAssets.push({ name: name, val: valTWD, category: category });
            }

            if(groups[displayCategory]) {
                groups[displayCategory].push({ name, qty, displayPrice, valTWD, category, typeStr: (category === 'debt' ? 'PRINCIPAL' : (category === 'interest' ? 'INTEREST' : '')) });
            }
        }

        historyData.sort((a, b) => new Date(a.date) - new Date(b.date));

        leverage.networth = totalNetWorth; leverage.debt = totalDebtAbs; leverage.interest = totalInterestAbs;
        let totalGrossAssets = totalNetWorth + totalDebtAbs + totalInterestAbs;
        let totalLiabilities = totalDebtAbs + totalInterestAbs;

        window.cachedTotal = totalNetWorth;
        let displayNum = totalNetWorth;
        let suffix = "";
        if(Math.abs(totalNetWorth) >= 100000000) { suffix = " ÂÑÑ"; displayNum = totalNetWorth / 100000000; }
        else if (Math.abs(totalNetWorth) >= 10000) { suffix = " Ëê¨"; displayNum = totalNetWorth / 10000; }
        
        animateValue(document.getElementById('displayTotal'), 0, displayNum, 1500, totalNetWorth < 0, "", "");
        document.getElementById('displayUnit').innerText = suffix;
        
        drawTrendChart(historyData, totalNetWorth);
        drawStructureBar(leverage, totalGrossAssets);
        drawPie('chartDebt', 'legendDebt', 'valDebt', debtBreakdown, totalLiabilities, ['debt', 'interest']);
        drawPie('chartCategory', 'legendCategory', 'valCategory', cats, totalAssetsOnly, ['realestate', 'car', 'cash', 'us_stock', 'tw_stock', 'bond']);
        drawPie('chartLiquidity', 'legendLiquidity', 'valLiquidity', liquidity, totalAssetsOnly, ['fixed', 'liquid']);
        drawPie('chartCurrency', 'legendCurrency', 'valCurrency', currency, totalAssetsOnly, ['usd', 'twd']);
        renderDeepDive(totalAssetsOnly, totalLiabilities, liquidity.liquid, cats.cash || 0, allAssets, historyData, totalNetWorth, cats);

        const container = document.getElementById('assetListContainer');
        const groupTotals = {};
        Object.keys(groups).forEach(key => { if(groups[key].length > 0) groupTotals[key] = groups[key].reduce((sum, item) => sum + item.valTWD, 0); });
        const assetKeys = Object.keys(groups).filter(k => k !== 'debt' && groups[k].length > 0);
        const debtKeys = Object.keys(groups).filter(k => k === 'debt' && groups[k].length > 0);
        assetKeys.sort((a, b) => groupTotals[b] - groupTotals[a]);
        const order = [...assetKeys, ...debtKeys];
        
        order.forEach(key => {
            const items = groups[key];
            if(items && items.length > 0) {
                items.sort((a, b) => b.valTWD - a.valTWD);
                let groupTotal = Math.round(items.reduce((sum, item) => sum + item.valTWD, 0));
                let isDebtGroup = (key === 'debt');
                let displayTotal = formatChineseCurrency(groupTotal);
                if(isDebtGroup) displayTotal = `- ${displayTotal}`;
                let pct = 0; let rawPct = 0;
                if(isDebtGroup) { if(totalLiabilities > 0) rawPct = (groupTotal / totalLiabilities * 100); } 
                else { if(totalAssetsOnly > 0) rawPct = (groupTotal / totalAssetsOnly * 100); }
                pct = rawPct.toFixed(1);

                const groupDiv = document.createElement('div');
                groupDiv.className = 'category-group';
                let iconPath = categoryIcons[key] || categoryIcons['default'];
                if (key === 'debt') iconPath = categoryIcons['debt'];
                let iconColor = colors[key];
                
                groupDiv.innerHTML = `
                    <div class="weight-bar" style="background-color: ${iconColor}; width: 0%;"></div>
                    <div class="category-header ${isDebtGroup ? 'is-debt' : ''}" onclick="toggleGroup(this)">
                        <div class="cat-left-content">
                            <div class="cat-icon-box" style="background: ${hexToRgba(iconColor, 0.15)}"><svg viewBox="0 0 24 24" style="fill: ${iconColor}">${iconPath}</svg></div>
                            <div class="cat-text-info"><span class="cat-name">${typeLabels[key]}</span><span class="cat-count">${items.length}</span></div>
                        </div>
                        <div class="cat-right-content"><span class="cat-amount" data-value="${groupTotal}">NT$ ${displayTotal}</span><span class="cat-pct">${pct}% ${isDebtGroup ? 'of Liab.' : 'of Asset'}</span></div>
                        <div class="arrow-icon">‚ñº</div>
                    </div>
                    <div class="category-content"></div>
                `;
                groupDiv.querySelector('.weight-bar').style.width = rawPct + '%'; 
                const contentDiv = groupDiv.querySelector('.category-content');
                items.forEach(item => {
                    const isLiability = (item.category === 'debt' || item.category === 'interest');
                    let itemSign = isLiability ? '-' : '';
                    let itemClass = '';
                    if (item.category === 'debt') itemClass = 'is-debt';
                    if (item.category === 'interest') itemClass = 'is-interest';
                    let tag = '';
                    if(isLiability) tag = item.typeStr;
                    else if(totalAssetsOnly > 0) tag = (item.valTWD / totalAssetsOnly * 100).toFixed(1) + '%';
                    let valRounded = Math.round(item.valTWD);
                    const itemEl = document.createElement('div');
                    itemEl.className = `asset-item ${itemClass}`;
                    itemEl.innerHTML = `<div class="asset-info"><h4>${item.name}</h4><p>${item.qty} ÂñÆ‰Ωç ‚Ä¢ ${item.displayPrice}</p></div><div class="asset-val">${itemSign} NT$ ${valRounded.toLocaleString()}<small>${tag}</small></div>`;
                    contentDiv.appendChild(itemEl);
                });
                container.appendChild(groupDiv);
            }
        });
    }

    function renderDeepDive(totalAssets, totalDebt, liquidAssets, cashTotal, allAssets, history, currentNetWorth, cats) {
        const netLiquid = liquidAssets - totalDebt;
        document.getElementById('kpiNetLiquid').innerText = "NT$ " + formatChineseCurrency(netLiquid);
        document.getElementById('kpiTotalDebt').innerText = "NT$ " + formatChineseCurrency(totalDebt);
        let solvency = 0;
        if(totalDebt > 0) solvency = (liquidAssets / totalDebt).toFixed(1); else solvency = "‚àû";
        const solvencyEl = document.getElementById('kpiSolvency');
        solvencyEl.innerText = solvency + "x";
        if(solvency < 1) solvencyEl.style.color = '#A6444D'; else solvencyEl.style.color = '#569C78';

        let mom = 0; let ytd = 0; let ath = 0;
        if(history.length > 0) {
             const now = new Date();
             const thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30));
             const oneYearAgo = new Date(new Date().getFullYear(), 0, 1);
             let momVal = history[0].val; let ytdVal = history[0].val; let maxVal = -Infinity;
             history.forEach(h => {
                 const d = new Date(h.date);
                 if (d < thirtyDaysAgo) momVal = h.val;
                 if (d < oneYearAgo) ytdVal = h.val;
                 if (h.val > maxVal) maxVal = h.val;
             });
             if (currentNetWorth > maxVal) maxVal = currentNetWorth;
             if(momVal !== 0) mom = ((currentNetWorth - momVal) / momVal * 100).toFixed(1);
             if(ytdVal !== 0) ytd = ((currentNetWorth - ytdVal) / ytdVal * 100).toFixed(1);
             if(maxVal !== 0) ath = ((currentNetWorth - maxVal) / maxVal * 100).toFixed(1);
        }
        setGrowthColor('kpiMoM', mom); setGrowthColor('kpiYTD', ytd); setGrowthColor('kpiATH', ath);

        const aggressive = (cats.us_stock || 0) + (cats.tw_stock || 0);
        const defensive = (cats.cash || 0) + (cats.bond || 0);
        const anchor = (cats.realestate || 0);
        const totalAlloc = aggressive + defensive + anchor;
        if(totalAlloc > 0) {
            const aggPct = (aggressive / totalAlloc * 100).toFixed(0);
            const defPct = (defensive / totalAlloc * 100).toFixed(0);
            const ancPct = (anchor / totalAlloc * 100).toFixed(0);
            document.getElementById('riskAggressive').style.width = aggPct + '%';
            document.getElementById('riskDefensive').style.width = defPct + '%';
            document.getElementById('riskAnchor').style.width = ancPct + '%';
            document.getElementById('valAggressive').innerText = aggPct + '%';
            document.getElementById('valDefensive').innerText = defPct + '%';
            document.getElementById('valAnchor').innerText = ancPct + '%';
        }

        const topList = document.getElementById('topHoldingsList');
        topList.innerHTML = '';
        allAssets.sort((a, b) => b.val - a.val);
        const top5 = allAssets.slice(0, 5);
        top5.forEach(item => {
            const pct = (item.val / totalAssets * 100).toFixed(1);
            const displayVal = formatChineseCurrency(Math.round(item.val));
            const barColor = colors[item.category] || '#555';
            const div = document.createElement('div');
            div.className = 'holding-item';
            div.innerHTML = `<div class="holding-header"><span>${item.name}</span><span class="holding-val">${displayVal} (${pct}%)</span></div><div class="holding-bar-bg"><div class="holding-bar-fill" style="width: 0%; background-color: ${barColor};" data-width="${pct}%"></div></div>`;
            topList.appendChild(div);
        });
    }

    function setGrowthColor(id, val) {
        const el = document.getElementById(id);
        const sign = val > 0 ? "+" : "";
        el.innerText = sign + val + "%";
        if(val > 0) el.style.color = '#569C78'; else if(val < 0) el.style.color = '#A6444D'; else el.style.color = '#888';
    }

    // --- RECOVERED FUNCTIONS (Fixed Crash) ---
    function drawTrendChart(history, currentVal) {
        const wrapper = document.getElementById('trendChartWrapper');
        const svg = document.getElementById('trendSvg');
        const labelContainer = document.getElementById('chartLabels');
        
        if (!history || history.length === 0) { wrapper.style.display = 'none'; return; }
        wrapper.style.display = 'block';
        
        let points = [...history]; 
        let vals = points.map(p => p.val);
        let maxVal = Math.max(...vals); let minVal = Math.min(...vals);
        let maxIdx = vals.lastIndexOf(maxVal); let minIdx = vals.lastIndexOf(minVal);
        let range = maxVal - minVal; if(range === 0) range = 1;
        
        const w = 1000; const h = 200; const paddingY = 40; 
        
        let pathD = ""; let areaD = ""; 
        chartPoints = [];
        labelContainer.innerHTML = '';

        points.forEach((p, i) => {
            let x = (i / (points.length - 1)) * w;
            if(points.length === 1) x = w/2;
            let normalizedY = (p.val - minVal) / range;
            let y = (h - paddingY) - (normalizedY * (h - paddingY * 2));
            chartPoints.push({ x, y, val: p.val, date: p.date });

            if (i === 0) { pathD += `M ${x} ${y}`; areaD += `M ${x} ${h} L ${x} ${y}`; } 
            else { pathD += ` L ${x} ${y}`; areaD += ` L ${x} ${y}`; }

            if (i === maxIdx || i === minIdx) {
                let labelDiv = document.createElement('div');
                labelDiv.className = 'chart-label';
                // V67 FIX: Strict Integer for chart labels too
                labelDiv.innerText = formatTrendVal(p.val);
                labelDiv.style.left = (x / 10) + '%';
                let offset = (i === maxIdx) ? -25 : 10;
                labelDiv.style.top = (y + offset) + 'px';
                if (i === 0) labelDiv.classList.add('left');
                if (i === points.length - 1) labelDiv.classList.add('right');
                labelContainer.appendChild(labelDiv);
            }
        });
        
        areaD += ` L ${points[points.length-1].length === 1 ? w/2 : w} ${h} Z`;
        
        const defs = svg.querySelector('defs').outerHTML;
        const group = document.getElementById('crosshairGroup').outerHTML;
        svg.innerHTML = `${defs}<path d="${areaD}" class="trend-area" /><path d="${pathD}" class="trend-line" />${group}`;
        
        const svgHeight = 200;
        requestAnimationFrame(() => {
            const line = svg.querySelector('.trend-line');
            const area = svg.querySelector('.trend-area');
            if(line) {
                line.style.transition = 'none';
                line.style.strokeDasharray = line.getTotalLength();
                line.style.strokeDashoffset = line.getTotalLength();
                if(area) area.classList.remove('visible');
                requestAnimationFrame(() => {
                    line.getBoundingClientRect(); 
                    line.style.transition = 'stroke-dashoffset 2s var(--ios-ease)';
                    line.style.strokeDashoffset = '0';
                    if(area) setTimeout(() => area.classList.add('visible'), 1500); 
                });
                document.querySelectorAll('.chart-label').forEach(l => {
                    l.classList.remove('visible');
                    setTimeout(() => l.classList.add('visible'), 1500);
                });
            }
        });

        setupInteraction(w, h, currentVal); 
    }

    function setupInteraction(svgWidth, svgHeight, currentTotal) {
        const overlay = document.getElementById('trendOverlay');
        const crosshairGroup = document.getElementById('crosshairGroup');
        const crossX = document.getElementById('crosshairX');
        const crossY = document.getElementById('crosshairY');
        const crossDotHtml = document.getElementById('crosshairDotHtml');
        const hud = document.getElementById('chartHud');
        const hudDate = document.getElementById('hudDate');
        const hudVal = document.getElementById('hudVal');
        const hudDelta = document.getElementById('hudDelta');

        function handleMove(clientX) {
            const rect = overlay.getBoundingClientRect();
            const mouseX = clientX - rect.left;
            const svgX = (mouseX / rect.width) * svgWidth;
            if(chartPoints.length === 0) return;
            let nearest = chartPoints[0];
            let minDist = Math.abs(svgX - nearest.x);
            for(let p of chartPoints) {
                let dist = Math.abs(svgX - p.x);
                if(dist < minDist) { minDist = dist; nearest = p; }
            }

            crosshairGroup.style.opacity = 1;
            crossX.setAttribute('x1', nearest.x); crossX.setAttribute('x2', nearest.x);
            crossY.setAttribute('y1', nearest.y); crossY.setAttribute('y2', nearest.y);
            
            crossDotHtml.style.opacity = 1;
            crossDotHtml.style.left = (nearest.x / 10) + '%';
            crossDotHtml.style.top = (nearest.y / 200 * 100) + '%';

            hud.classList.add('visible');
            hudDate.innerText = nearest.date;
            hudVal.innerText = formatTrendVal(nearest.val);

            let diff = currentTotal - nearest.val;
            let sign = diff >= 0 ? "+" : "";
            // V67: Integer Diff
            let diffStr = sign + Math.round(diff).toLocaleString();
            hudDelta.innerText = diffStr;
            hudDelta.className = 'hud-delta'; 
            if (diff > 0) hudDelta.classList.add('up');
            else if (diff < 0) hudDelta.classList.add('down');
            else hudDelta.classList.add('flat');
        }

        function handleEnd() {
            crosshairGroup.style.opacity = 0; crossDotHtml.style.opacity = 0; hud.classList.remove('visible');
        }

        overlay.onmousemove = (e) => handleMove(e.clientX);
        overlay.onmouseleave = handleEnd;
        overlay.ontouchmove = (e) => { e.preventDefault(); handleMove(e.touches[0].clientX); };
        overlay.ontouchend = handleEnd;
    }

    function drawStructureBar(data, total) {
        if(total === 0) return;
        const pctNet = (data.networth / total) * 100;
        const pctDebt = (data.debt / total) * 100;
        const pctInt = (data.interest / total) * 100;
        document.getElementById('barNetworth').style.width = pctNet + '%';
        document.getElementById('barDebt').style.width = pctDebt + '%';
        document.getElementById('barInterest').style.width = pctInt + '%';
        document.getElementById('structNetWorth').innerText = formatCompact(data.networth);
        const debtRatio = ((data.debt + data.interest) / total * 100).toFixed(1);
        document.getElementById('structDebtRatio').innerText = debtRatio + '%';
        const legendBox = document.getElementById('legendLeverage');
        legendBox.innerHTML = '';
        const keys = ['networth', 'debt', 'interest'];
        keys.forEach(key => {
            const val = data[key];
            if(val > 0) {
                const pct = (val / total * 100).toFixed(1);
                const valCompact = formatCompact(val);
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<div class="legend-dot" style="background: ${colors[key]}"></div><span class="legend-name">${typeLabels[key]} ${pct}% <span style="opacity:0.7;">(${valCompact})</span></span>`;
                legendBox.appendChild(item);
            }
        });
    }

    function drawPie(chartId, legendId, valId, dataMap, total, keysOrder) {
        if (total === 0) return;
        let grad = []; let cur = 0;
        for (let type of keysOrder) {
            let val = dataMap[type] || 0;
            if (val > 0) {
                let deg = (val / total) * 360;
                grad.push(`${colors[type]} ${cur}deg ${cur + deg}deg`);
                cur += deg;
            }
        }
        const ring = document.getElementById(chartId); 
        if(ring) ring.style.background = `conic-gradient(${grad.join(', ')})`;
        document.getElementById(valId).innerText = formatCompact(Math.round(total));
        const legendBox = document.getElementById(legendId);
        legendBox.innerHTML = '';
        for (let type of keysOrder) {
            let val = dataMap[type] || 0;
            if (val > 0) {
                let pct = (val / total * 100).toFixed(1);
                let valCompact = formatCompact(val);
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<div class="legend-dot" style="background: ${colors[type]}"></div><span class="legend-name">${typeLabels[type]} ${pct}% <span style="opacity:0.7;">(${valCompact})</span></span>`;
                legendBox.appendChild(item);
            }
        }
    }
</script>

</body>
</html>
