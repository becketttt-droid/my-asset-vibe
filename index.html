<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="My Assets">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“Š</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%231c1e24%22 rx=%2220%22 ry=%2220%22/><text x=%2250%22 y=%2250%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2260%22>ğŸ“Š</text></svg>">

    <title>My Net Worth (V31 Trend)</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        :root {
            --bg: #0f1115;
            --card: #1c1e24;
            --card-hover: #252830;
            --text: #ffffff;
            --subtext: #8b9bb4;
            --accent: #4a90e2;
            --trend: #00d2d3; /* è¶¨å‹¢ç·šé¡è‰² */
            --edit-btn: #2ecc71;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; 
            padding: calc(20px + var(--safe-top)) 20px calc(20px + var(--safe-bottom)) 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 1100px; transition: max-width 0.3s ease; }
        .config-wrapper { width: 100%; max-width: 500px; margin: 0 auto; }

        .config-box {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 16px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        .csv-input {
            width: 100%; background: #000; border: 1px solid #333; color: #fff;
            padding: 12px; border-radius: 10px; font-size: 14px; margin-top: 10px; outline: none;
            color: #888;
        }
        .csv-input:focus { border-color: var(--accent); color: #fff; }

        .toolbar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .toolbar-left { display: flex; gap: 10px; }
        
        .btn-base {
            cursor: pointer; font-weight: 600; font-size: 12px;
            padding: 6px 12px; border-radius: 8px; text-decoration: none;
            display: inline-flex; align-items: center; transition: opacity 0.2s;
        }
        .btn-base:active { opacity: 0.7; }
        .btn-refresh { color: var(--accent); background: rgba(74, 144, 226, 0.15); }
        .btn-edit { color: var(--edit-btn); background: rgba(46, 204, 113, 0.15); }

        .rate-pill {
            font-size: 13px; color: #aaa; 
            background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .rate-val { color: #fff; font-weight: bold; font-family: monospace; font-size: 14px; }

        header { text-align: center; margin-bottom: 20px; }
        .total-title { font-size: 14px; color: #888; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
        .total-amount { font-size: 56px; font-weight: 800; margin: 0; line-height: 1; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .currency-tag { font-size: 24px; color: var(--subtext); margin-right: 5px;}

        /* --- V31: è¶¨å‹¢åœ–æ¨£å¼ (SVG) --- */
        .trend-wrapper {
            width: 100%; height: 120px; margin-bottom: 30px; position: relative;
            background: linear-gradient(180deg, rgba(0,210,211,0.05) 0%, rgba(0,0,0,0) 100%);
            border-radius: 12px; overflow: hidden;
            display: none; /* æœ‰æ•¸æ“šæ‰é¡¯ç¤º */
        }
        .trend-svg { width: 100%; height: 100%; display: block; cursor: crosshair; }
        .trend-line { fill: none; stroke: var(--trend); stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
        .trend-area { fill: rgba(0, 210, 211, 0.1); stroke: none; }
        .trend-dot { fill: var(--bg); stroke: var(--trend); stroke-width: 2; r: 4; }
        
        /* Tooltip */
        .trend-tooltip {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 4px 10px; border-radius: 6px;
            font-size: 12px; color: #fff; pointer-events: none; opacity: 0; transition: opacity 0.2s;
            border: 1px solid rgba(255,255,255,0.1); white-space: nowrap;
        }
        .trend-tooltip.visible { opacity: 1; }

        /* Charts Layout */
        .charts-wrapper {
            display: flex; gap: 15px; overflow-x: auto; 
            padding-bottom: 10px; margin-bottom: 20px;
            scroll-snap-type: x mandatory; scrollbar-width: none; 
        }
        .charts-wrapper::-webkit-scrollbar { display: none; }

        .chart-card {
            background: var(--card); border-radius: 20px; padding: 20px;
            min-width: 280px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            scroll-snap-align: center;
            display: flex; flex-direction: column; align-items: center;
            flex: 1;
        }
        .chart-title { font-size: 14px; font-weight: bold; margin-bottom: 15px; color: var(--subtext); width: 100%; text-align: center; }
        
        .chart-container {
            width: 160px; height: 160px; border-radius: 50%; margin-bottom: 15px;
            background: #333; position: relative;
        }
        .chart-inner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 110px; height: 110px; background-color: var(--card); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            color: var(--subtext); font-size: 12px; text-align: center;
        }
        .chart-inner .inner-val { font-size: 16px; font-weight: bold; color: #fff; }
        .chart-inner .inner-label { font-size: 10px; color: #888; margin-top: 2px; }

        /* Structure Bar */
        .structure-container { width: 100%; margin-bottom: 20px; padding: 0 10px; }
        .structure-bar {
            width: 100%; height: 24px; background: #333; border-radius: 12px;
            display: flex; overflow: hidden; margin-bottom: 10px;
        }
        .struct-seg { height: 100%; transition: width 0.5s ease; }
        .struct-metrics { display: flex; justify-content: space-between; width: 100%; font-size: 12px; color: var(--subtext); }
        .struct-metric-item { text-align: center; }
        .metric-big.net-highlight { color: #3498db; }
        .metric-big { font-size: 18px; font-weight: bold; color: #fff; display: block; }
        .metric-label { font-size: 10px; opacity: 0.7; }

        .legend-box { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; width: 100%; }
        .legend-item {
            display: flex; align-items: center;
            background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 20px;
            font-size: 11px; border: 1px solid rgba(255,255,255,0.05); white-space: nowrap;
        }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        /* Accordion */
        .category-group { margin-bottom: 15px; border-radius: 16px; overflow: hidden; background-color: var(--card); transition: all 0.3s ease; }
        .category-group.open { box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .category-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background-color: var(--card); min-height: 44px; }
        .cat-title-area { display: flex; align-items: center; gap: 12px; }
        .cat-icon { width: 10px; height: 10px; border-radius: 50%; }
        .cat-name { font-size: 16px; font-weight: bold; color: #fff; }
        .cat-count { font-size: 12px; color: var(--subtext); background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; }
        .cat-total-area { text-align: right; }
        .cat-amount { font-size: 16px; font-weight: bold; color: #fff; display: block; }
        .cat-pct { font-size: 12px; color: var(--subtext); }
        .arrow-icon { transition: transform 0.3s ease; opacity: 0.5; margin-left: 10px; font-size: 12px;}
        .category-group.open .arrow-icon { transform: rotate(180deg); opacity: 1; }
        .category-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background-color: rgba(0,0,0,0.2); }
        .category-group.open .category-content { max-height: 2000px; }

        .asset-item { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .asset-item:last-child { border-bottom: none; }
        .asset-info h4 { margin: 0 0 4px 0; font-size: 15px; color: #ddd; }
        .asset-info p { margin: 0; font-size: 12px; color: var(--subtext); }
        .asset-val { text-align: right; font-weight: 500; font-size: 15px; }
        .asset-val small { font-size: 11px; opacity: 0.7; display: block;}
        
        .is-debt .cat-amount, .is-debt .asset-val { color: #ff4757; }
        .is-interest .asset-val { color: #536dfe; }

        .loading-text { color: #f39c12; text-align: center; margin-top: 20px; display: none;}
        .error-text { color: #e74c3c; background: rgba(231, 76, 60, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px; display: none; line-height: 1.5;}
        .scroll-hint { text-align: center; font-size: 10px; color: #555; margin-top: -10px; margin-bottom: 20px; }

        @media (min-width: 768px) {
            .container { padding: 40px; }
            .charts-wrapper { overflow-x: visible; flex-wrap: wrap; justify-content: center; gap: 20px; }
            .chart-card { min-width: 220px; flex: 1 1 200px; max-width: 300px; }
            .scroll-hint { display: none; }
            .asset-list-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;}
        }
    </style>
</head>
<body>

<div class="container">
    <div class="config-wrapper">
        <div class="config-box">
            <div class="toolbar">
                <div class="toolbar-left">
                    <a href="https://docs.google.com/spreadsheets/d/1HrG-LV9lYJ0c4OCBFmqz_gGGyIdWHHK92eNSyCPOCuU/edit?usp=drivesdk" target="_blank" class="btn-base btn-edit">ğŸ“ ç·¨è¼¯</a>
                    <span class="btn-base btn-refresh" onclick="fetchData()">ğŸ”„ é‡æ•´</span>
                </div>
                <div class="rate-pill">
                    <span>ğŸ‡ºğŸ‡¸</span>
                    <span id="rateDisplay" class="rate-val">32.5</span>
                </div>
            </div>
            <input type="text" id="csvUrl" class="csv-input" placeholder="Google Sheet CSV é€£çµ..." onchange="saveUrl()">
            <div id="errorMsg" class="error-text"></div>
        </div>
    </div>

    <header>
        <div class="total-title">NET WORTH</div>
        <div class="total-amount"><span class="currency-tag">NT$</span> <span id="displayTotal">0</span></div>
    </header>

    <div id="trendChartWrapper" class="trend-wrapper">
        <div id="trendTooltip" class="trend-tooltip"></div>
        <svg id="trendSvg" class="trend-svg" viewBox="0 0 1000 200" preserveAspectRatio="none"></svg>
    </div>

    <div class="charts-wrapper">
        <div class="chart-card">
            <div class="chart-title">è³‡é‡‘çµæ§‹ (Structure)</div>
            <div class="structure-container">
                <div class="struct-metrics" style="margin-bottom:10px;">
                    <div class="struct-metric-item" style="text-align:left;">
                        <span class="metric-big net-highlight" id="structNetWorth">0</span>
                        <span class="metric-label">æ·¨å€¼ (Net Worth)</span>
                    </div>
                    <div class="struct-metric-item" style="text-align:right;">
                        <span class="metric-big" style="color:#ff4757;" id="structDebtRatio">0%</span>
                        <span class="metric-label">è² å‚µæ¯” (Debt Ratio)</span>
                    </div>
                </div>
                <div class="structure-bar">
                    <div id="barNetworth" class="struct-seg" style="background:#3498db; width:0%;"></div>
                    <div id="barDebt" class="struct-seg" style="background:#ff4757; width:0%;"></div>
                    <div id="barInterest" class="struct-seg" style="background:#3f51b5; width:0%;"></div>
                </div>
            </div>
            <div id="legendLeverage" class="legend-box"></div>
        </div>

        <div class="chart-card">
            <div class="chart-title">è² å‚µåˆ†ä½ˆ (Liabilities)</div>
            <div class="chart-container" id="chartDebt"><div class="chart-inner"><div class="inner-val" id="valDebt">0</div><div class="inner-label">ç¸½è² å‚µ</div></div></div>
            <div id="legendDebt" class="legend-box"></div>
        </div>

        <div class="chart-card">
            <div class="chart-title">è³‡ç”¢é…ç½® (Assets)</div>
            <div class="chart-container" id="chartCategory"><div class="chart-inner"><div class="inner-val" id="valCategory">0</div><div class="inner-label">ç¸½è³‡ç”¢</div></div></div>
            <div id="legendCategory" class="legend-box"></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">æµå‹•æ€§ (Liquidity)</div>
            <div class="chart-container" id="chartLiquidity"><div class="chart-inner"><div class="inner-val" id="valLiquidity">0</div><div class="inner-label">ç¸½æµå‹•</div></div></div>
            <div id="legendLiquidity" class="legend-box"></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">å¹£åˆ¥æ›éšª (Currency)</div>
            <div class="chart-container" id="chartCurrency"><div class="chart-inner"><div class="inner-val" id="valCurrency">0</div><div class="inner-label">ç¸½æ›éšª</div></div></div>
            <div id="legendCurrency" class="legend-box"></div>
        </div>
    </div>
    <div class="scroll-hint">â† å·¦å³æ»‘å‹•æŸ¥çœ‹ 5 å¼µåˆ†æåœ– â†’</div>

    <div id="loading" class="loading-text">é‹ç®—ä¸­...</div>
    <div id="assetListContainer" class="asset-list-container"></div>
</div>

<script>
    const colors = { 
        us_stock: '#4a90e2', tw_stock: '#e91e63', bond: '#f1c40f', cash: '#2ecc71', realestate: '#9b59b6', 
        car: '#e67e22', debt: '#ff4757', interest: '#3f51b5',
        liquid: '#2ecc71', fixed: '#9b59b6', usd: '#4a90e2', twd: '#e91e63', networth: '#3498db'
    };
    
    const typeLabels = { 
        us_stock: 'ç¾è‚¡', tw_stock: 'å°è‚¡', bond: 'å‚µåˆ¸', cash: 'ç¾é‡‘/å­˜æ¬¾', 
        realestate: 'æˆ¿ç”¢', car: 'è»Šè¼›', 
        debt: 'è² å‚µæœ¬é‡‘', interest: 'åˆ©æ¯',
        liquid: 'æµå‹•', fixed: 'å›ºå®š', usd: 'ç¾å…ƒ', twd: 'å°å¹£', networth: 'æ·¨å€¼'
    };
    
    document.getElementById('csvUrl').value = localStorage.getItem('vibeSheetUrl') || '';
    let currentRate = parseFloat(localStorage.getItem('vibeUsdRate')) || 32.5;
    document.getElementById('rateDisplay').innerText = currentRate;
    if(document.getElementById('csvUrl').value) fetchData();

    function saveUrl() { localStorage.setItem('vibeSheetUrl', document.getElementById('csvUrl').value); fetchData(); }
    function csvSplit(str) {
        const result = []; let current = ''; let inQuote = false;
        for (let i = 0; i < str.length; i++) {
            const char = str[i];
            if (char === '"') { inQuote = !inQuote; continue; }
            if (char === ',' && !inQuote) { result.push(current.trim()); current = ''; } else { current += char; }
        }
        result.push(current.trim()); return result;
    }
    function formatCompact(num) {
        if (num >= 100000000) return (num / 100000000).toFixed(2) + 'å„„';
        if (num >= 10000) return (num / 10000).toFixed(0) + 'è¬';
        return (num / 1000).toFixed(1) + 'k';
    }
    function toggleGroup(header) { header.parentElement.classList.toggle('open'); }

    async function fetchData(needsNetwork = true) {
        let url = document.getElementById('csvUrl').value.trim();
        if (!url) return;
        if (!needsNetwork && window.cachedCSV) { parseCSV(window.cachedCSV); return; }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('errorMsg').style.display = 'none';
        document.getElementById('assetListContainer').innerHTML = '';

        const cacheBuster = encodeURIComponent(url + '&t=' + Date.now());
        const proxies = [
            'https://api.allorigins.win/raw?url=' + cacheBuster,
            'https://corsproxy.io/?' + cacheBuster,
            'https://thingproxy.freeboard.io/fetch/' + cacheBuster
        ];
        let text = ''; let success = false;
        for (let proxy of proxies) {
            try {
                const res = await fetch(proxy);
                if (res.ok) {
                    text = await res.text();
                    if (!text.trim().startsWith('<!DOCTYPE html') && !text.includes('<html')) { success = true; break; }
                }
            } catch (e) { }
        }
        if (success) {
            window.cachedCSV = text; parseCSV(text);
            document.getElementById('loading').style.display = 'none';
        } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'block';
            document.getElementById('errorMsg').innerHTML = `âš ï¸ é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ•´ã€‚`;
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.split('\n');
        let foundRate = false;
        if (lines.length > 1) {
            const row2 = csvSplit(lines[1]); 
            if (row2.length >= 6) {
                const r = parseFloat(row2[5].replace(/,/g, ''));
                if (!isNaN(r) && r > 20 && r < 50) { 
                    currentRate = r; document.getElementById('rateDisplay').innerText = currentRate;
                    localStorage.setItem('vibeUsdRate', currentRate);
                }
            }
        }

        let totalNetWorth = 0; let totalAssetsOnly = 0;
        let totalDebtAbs = 0; let totalInterestAbs = 0;
        
        let cats = { us_stock:0, tw_stock:0, bond:0, cash:0, realestate:0, car:0, debt:0, interest:0 };
        let liquidity = { liquid: 0, fixed: 0 };
        let currency = { usd: 0, twd: 0 };
        let leverage = { networth: 0, debt: 0, interest: 0 };
        let debtBreakdown = { debt: 0, interest: 0 };
        
        // V31: æ­·å²æ•¸æ“šå®¹å™¨
        let historyData = [];

        let groups = { 
            realestate: [], car: [], cash: [], us_stock: [], tw_stock: [], bond: [], debt: [] 
        };

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const row = csvSplit(lines[i]); 
            if (row.length < 4) continue;
            let rawPrice = row[2] ? row[2].replace(/,/g, '') : '0';
            let rawQty = row[3] ? row[3].replace(/,/g, '') : '0';
            const price = parseFloat(rawPrice); const qty = parseFloat(rawQty);   
            if (isNaN(qty) || isNaN(price)) continue;

            const typeStr = row[0].toLowerCase().trim(); const name = row[1]; 
            let category = 'cash'; let displayCategory = 'cash';
            
            // --- V31: æ­·å²è³‡æ–™æ””æˆª ---
            if (typeStr === 'history') {
                historyData.push({ date: name, val: price * qty }); // nameæ˜¯æ—¥æœŸ, priceæ˜¯æ·¨å€¼
                continue; // è·³éï¼Œä¸ç®—å…¥ç¸½è³‡ç”¢
            }

            if (typeStr === 'debt') { 
                category = 'debt'; displayCategory = 'debt'; 
            } else if (typeStr === 'interest') { 
                category = 'interest'; displayCategory = 'debt'; 
            } else if (typeStr.includes('realestate') || typeStr.includes('house')) { 
                category = 'realestate'; displayCategory = 'realestate'; 
            } else if (typeStr.includes('car')) { 
                category = 'car'; displayCategory = 'car'; 
            } else if (typeStr.includes('bond')) { 
                category = 'bond'; displayCategory = 'bond'; 
            } else if (typeStr.includes('cash') || typeStr.includes('deposit') || typeStr.includes('bank') || typeStr.includes('saving') || typeStr.includes('money') || typeStr === 'twd') {
                category = 'cash'; displayCategory = 'cash';
            } else if (typeStr.includes('us')) { 
                category = 'us_stock'; displayCategory = 'us_stock'; 
            } else if (typeStr.includes('stock') || typeStr.includes('tw') || typeStr.includes('0050')) { 
                category = 'tw_stock'; displayCategory = 'tw_stock'; 
            }

            let valTWD = 0; let displayPrice = '';
            const isAssetUSD = (category === 'us_stock') || (typeStr.includes('us') && !typeStr.includes('twd'));

            if (isAssetUSD) { valTWD = qty * price * currentRate; displayPrice = `US$ ${price.toLocaleString()}`; } 
            else { valTWD = qty * price; displayPrice = `NT$ ${price.toLocaleString()}`; }

            if(!cats[category]) cats[category] = 0; cats[category] += valTWD;
            
            if (category === 'debt') { 
                totalNetWorth -= valTWD; totalDebtAbs += valTWD; debtBreakdown.debt += valTWD;
            } else if (category === 'interest') { 
                totalNetWorth -= valTWD; totalInterestAbs += valTWD; debtBreakdown.interest += valTWD;
            } else {
                totalNetWorth += valTWD; totalAssetsOnly += valTWD;
                if (['realestate','car'].includes(category)) liquidity.fixed += valTWD; else liquidity.liquid += valTWD;
                if (isAssetUSD) currency.usd += valTWD; else currency.twd += valTWD;
            }

            if(groups[displayCategory]) {
                groups[displayCategory].push({
                    name, qty, displayPrice, valTWD, category, 
                    typeStr: (category === 'debt' ? 'PRINCIPAL' : (category === 'interest' ? 'INTEREST' : ''))
                });
            }
        }

        leverage.networth = totalNetWorth; leverage.debt = totalDebtAbs; leverage.interest = totalInterestAbs;
        let totalGrossAssets = totalNetWorth + totalDebtAbs + totalInterestAbs;
        let totalLiabilities = totalDebtAbs + totalInterestAbs;

        document.getElementById('displayTotal').innerText = Math.round(totalNetWorth).toLocaleString();
        
        // V31: ç¹ªè£½è¶¨å‹¢åœ–
        drawTrendChart(historyData, totalNetWorth);

        drawStructureBar(leverage, totalGrossAssets);
        drawPie('chartDebt', 'legendDebt', 'valDebt', debtBreakdown, totalLiabilities, ['debt', 'interest']);
        drawPie('chartCategory', 'legendCategory', 'valCategory', cats, totalAssetsOnly, ['realestate', 'car', 'cash', 'us_stock', 'tw_stock', 'bond']);
        drawPie('chartLiquidity', 'legendLiquidity', 'valLiquidity', liquidity, totalAssetsOnly, ['fixed', 'liquid']);
        drawPie('chartCurrency', 'legendCurrency', 'valCurrency', currency, totalAssetsOnly, ['usd', 'twd']);

        const container = document.getElementById('assetListContainer');
        const order = ['realestate', 'car', 'cash', 'us_stock', 'tw_stock', 'bond', 'debt'];
        
        order.forEach(key => {
            const items = groups[key];
            if(items && items.length > 0) {
                let groupTotal = items.reduce((sum, item) => sum + item.valTWD, 0);
                let isDebtGroup = (key === 'debt');
                let displayTotal = Math.round(groupTotal).toLocaleString();
                if(isDebtGroup) displayTotal = `- ${displayTotal}`;

                let pct = 0;
                if(isDebtGroup) {
                    if(totalLiabilities > 0) pct = (groupTotal / totalLiabilities * 100).toFixed(1);
                } else {
                    if(totalAssetsOnly > 0) pct = (groupTotal / totalAssetsOnly * 100).toFixed(1);
                }

                const groupDiv = document.createElement('div');
                groupDiv.className = 'category-group';
                groupDiv.innerHTML = `
                    <div class="category-header ${isDebtGroup ? 'is-debt' : ''}" onclick="toggleGroup(this)">
                        <div class="cat-title-area">
                            <div class="cat-icon" style="background: ${colors[key]}"></div>
                            <span class="cat-name">${typeLabels[key]}</span>
                            <span class="cat-count">${items.length}</span>
                        </div>
                        <div class="cat-total-area">
                            <span class="cat-amount">NT$ ${displayTotal}</span>
                            <span class="cat-pct">${pct}% ${isDebtGroup ? 'of Liab.' : 'of Asset'}</span>
                        </div>
                        <div class="arrow-icon">â–¼</div>
                    </div>
                    <div class="category-content"></div>
                `;
                const contentDiv = groupDiv.querySelector('.category-content');
                items.forEach(item => {
                    const isLiability = (item.category === 'debt' || item.category === 'interest');
                    let itemSign = isLiability ? '-' : '';
                    let itemClass = '';
                    if (item.category === 'debt') itemClass = 'is-debt';
                    if (item.category === 'interest') itemClass = 'is-interest';
                    let tag = '';
                    if(isLiability) tag = item.typeStr;
                    else if(totalAssetsOnly > 0) tag = (item.valTWD / totalAssetsOnly * 100).toFixed(1) + '%';
                    const itemEl = document.createElement('div');
                    itemEl.className = `asset-item ${itemClass}`;
                    itemEl.innerHTML = `
                        <div class="asset-info"><h4>${item.name}</h4><p>${item.qty} å–®ä½ â€¢ ${item.displayPrice}</p></div>
                        <div class="asset-val">${itemSign} NT$ ${Math.round(item.valTWD).toLocaleString()}<small>${tag}</small></div>
                    `;
                    contentDiv.appendChild(itemEl);
                });
                container.appendChild(groupDiv);
            }
        });
    }

    // V31: ç¹ªè£½è¶¨å‹¢åœ– (SVG)
    function drawTrendChart(history, currentVal) {
        const wrapper = document.getElementById('trendChartWrapper');
        const svg = document.getElementById('trendSvg');
        const tooltip = document.getElementById('trendTooltip');
        
        // å¦‚æœæ²’æœ‰æ­·å²æ•¸æ“šï¼Œéš±è—åœ–è¡¨
        if (!history || history.length === 0) {
            wrapper.style.display = 'none';
            return;
        }
        
        // é¡¯ç¤ºåœ–è¡¨
        wrapper.style.display = 'block';
        
        // æ•´ç†æ•¸æ“š (åŠ å…¥ç•¶å‰å€¼ä½œç‚ºæœ€å¾Œä¸€é»)
        // ç¢ºä¿æŒ‰æ™‚é–“æ’åº (é€™è£¡å‡è¨­ç”¨æˆ¶è¼¸å…¥é †åºæ­£ç¢ºï¼Œæˆ–æ˜¯å¯ä»¥åŠ å€‹ sort)
        let points = [...history]; 
        // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦æŠŠã€Œç¾åœ¨ã€è‡ªå‹•åŠ ç‚ºæœ€æ–°é»ï¼Œè®“ç·šåœ–é€£åˆ°ä»Šå¤©
        // points.push({ date: 'Now', val: currentVal }); 

        // æ‰¾å‡ºæœ€å¤§æœ€å°å€¼ä»¥ç¸®æ”¾
        let vals = points.map(p => p.val);
        let maxVal = Math.max(...vals);
        let minVal = Math.min(...vals);
        let range = maxVal - minVal;
        if(range === 0) range = 1; // é¿å…é™¤ä»¥é›¶

        // SVG å°ºå¯¸
        const w = 1000;
        const h = 200;
        const padding = 20;
        
        let pathD = "";
        let areaD = "";
        let circles = "";
        
        // ç¹ªè£½è·¯å¾‘
        points.forEach((p, i) => {
            let x = (i / (points.length - 1)) * w;
            if(points.length === 1) x = w/2; // åªæœ‰ä¸€é»æ™‚ç½®ä¸­
            
            // Yè»¸åè½‰ (æ•¸å€¼å¤§åœ¨ä¸Šé¢)
            let normalizedY = (p.val - minVal) / range;
            let y = h - (normalizedY * (h - padding*2) + padding);
            
            if (i === 0) {
                pathD += `M ${x} ${y}`;
                areaD += `M ${x} ${h} L ${x} ${y}`;
            } else {
                pathD += ` L ${x} ${y}`;
                areaD += ` L ${x} ${y}`;
            }
            
            // äº’å‹•é» (é€æ˜çš„å¤§åœ“åœˆç”¨æ–¼è§¸ç™¼ï¼Œå¯¦å¿ƒå°åœ“åœˆç”¨æ–¼é¡¯ç¤º)
            circles += `<circle cx="${x}" cy="${y}" r="4" class="trend-dot" />`;
            // éš±å½¢è§¸æ§å€
            circles += `<rect x="${x-20}" y="0" width="40" height="${h}" fill="transparent" 
                        ontouchstart="showTooltip(evt, '${p.date}', ${p.val}, ${x})" 
                        onmousemove="showTooltip(evt, '${p.date}', ${p.val}, ${x})" 
                        onmouseout="hideTooltip()" />`;
        });
        
        areaD += ` L ${points[points.length-1].length === 1 ? w/2 : w} ${h} Z`;

        svg.innerHTML = `
            <path d="${areaD}" class="trend-area" />
            <path d="${pathD}" class="trend-line" />
            ${circles}
        `;
    }

    // V31: Tooltip äº’å‹•é‚è¼¯
    window.showTooltip = function(evt, date, val, x) {
        const tooltip = document.getElementById('trendTooltip');
        tooltip.innerHTML = `${date}<br>NT$ ${formatCompact(val)}`;
        tooltip.classList.add('visible');
        // è¨ˆç®—ä½ç½® (ç°¡å–®è™•ç†)
        // ç”±æ–¼ SVG æ˜¯ viewBoxï¼Œé€™è£¡ x æ˜¯ SVG åº§æ¨™ï¼Œéœ€è¦è½‰æ›æˆ–æ˜¯ç°¡å–®ç”¨ CSS å±…ä¸­
        // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ç›´æ¥è®“ tooltip é¡¯ç¤ºåœ¨ä¸Šæ–¹ï¼Œä¸éš¨æ»‘é¼  X ç§»å‹• (å› ç‚ºæ‰‹æ©Ÿè§¸æ§ä¸æº–)
    }
    
    window.hideTooltip = function() {
        const tooltip = document.getElementById('trendTooltip');
        tooltip.classList.remove('visible');
    }

    function drawStructureBar(data, total) {
        if(total === 0) return;
        const pctNet = (data.networth / total) * 100;
        const pctDebt = (data.debt / total) * 100;
        const pctInt = (data.interest / total) * 100;

        document.getElementById('barNetworth').style.width = pctNet + '%';
        document.getElementById('barDebt').style.width = pctDebt + '%';
        document.getElementById('barInterest').style.width = pctInt + '%';

        document.getElementById('structNetWorth').innerText = formatCompact(data.networth);
        const debtRatio = ((data.debt + data.interest) / total * 100).toFixed(1);
        document.getElementById('structDebtRatio').innerText = debtRatio + '%';

        const legendBox = document.getElementById('legendLeverage');
        legendBox.innerHTML = '';
        const keys = ['networth', 'debt', 'interest'];
        keys.forEach(key => {
            const val = data[key];
            if(val > 0) {
                const pct = (val / total * 100).toFixed(1);
                const valCompact = formatCompact(val);
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<div class="legend-dot" style="background: ${colors[key]}"></div><span class="legend-name">${typeLabels[key]} ${pct}% <span style="opacity:0.7;">(${valCompact})</span></span>`;
                legendBox.appendChild(item);
            }
        });
    }

    function drawPie(chartId, legendId, valId, dataMap, total, keysOrder) {
        if (total === 0) return;
        let grad = []; let cur = 0;
        for (let type of keysOrder) {
            let val = dataMap[type] || 0;
            if (val > 0) {
                let deg = (val / total) * 360;
                grad.push(`${colors[type]} ${cur}deg ${cur + deg}deg`);
                cur += deg;
            }
        }
        document.getElementById(chartId).style.background = `conic-gradient(${grad.join(', ')})`;
        document.getElementById(valId).innerText = formatCompact(total);
        const legendBox = document.getElementById(legendId);
        legendBox.innerHTML = '';
        for (let type of keysOrder) {
            let val = dataMap[type] || 0;
            if (val > 0) {
                let pct = (val / total * 100).toFixed(1);
                let valCompact = formatCompact(val);
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<div class="legend-dot" style="background: ${colors[type]}"></div><span class="legend-name">${typeLabels[type]} ${pct}% <span style="opacity:0.7;">(${valCompact})</span></span>`;
                legendBox.appendChild(item);
            }
        }
    }
</script>

</body>
</html>
